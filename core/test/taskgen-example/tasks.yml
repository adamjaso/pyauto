---
deployments: [d1, d2]
apps: [a1, a2]
tasks:
- list_templates:
    clone:
    - clone,{{ dep }}_{{ app }}
    create_service:
    - create_service,{{ dep }}_{{ app }}_{{ srv }}
    dep_deploy:
    - init_deployment,{{ dep }}
    - '{{ dep }}_clone'
    - '{{ dep }}_generate'
    dep_app_create_services:
    - '{{ dep }}_{{ app }}_{{ srv }}_create'

  task_templates:
  # app task definitions
  - columns: [dep, app]
    contexts:
    - [deployments, apps]
    task_templates:
    - '{{ dep }}_{{ app }}_clone': clone

  # per dep definition
  - columns: [dep]
    contexts:
    - [deployments]
    task_templates:
    - '{{ dep }}_deploy': dep_deploy

  # service tag definitions
  - columns: [dep, app, srv]
    contexts:
    - [deployments, [a1], [s1, s2]]
    - [deployments, [a2], [s3]]
#    - [deployments, [a1, a2], [s4]]
    task_templates:
    - '{{ dep }}_{{ app }}_{{ srv }}_create': create_service
    - '{{ dep }}_{{ app }}_create_services': dep_app_create_services
